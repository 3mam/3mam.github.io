!function(t){var e={};function a(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=t,a.c=e,a.d=function(t,e,r){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(a.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)a.d(r,i,function(e){return t[e]}.bind(null,i));return r},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="",a(a.s=1)}([function(t,e){t.exports="<html> <body> <canvas id=glCanvas width=800 height=600></canvas> </body> </html>"},function(t,e,a){"use strict";a.r(e);var r,i;a(0);function n(t,e){const a=r.createShader(t);if(r.shaderSource(a,e),r.compileShader(a),r.getShaderParameter(a,r.COMPILE_STATUS))return a;console.log(r.getShaderInfoLog(a)),r.deleteShader(a)}!function(t){t[t.Vertex=0]="Vertex",t[t.Instance=1]="Instance",t[t.Uniform=2]="Uniform",t[t.Texture=3]="Texture",t[t.Matrix=4]="Matrix",t[t.UV=5]="UV",t[t.Mat4=6]="Mat4",t[t.Float=7]="Float",t[t.Vec4=8]="Vec4",t[t.Camera=9]="Camera"}(i||(i={}));class s{constructor(){const t=n(r.VERTEX_SHADER,"#version 300 es\n\t\tin vec4 VERTEX;\n\t\tin mat4 INSTANCE;\n\t\tin vec2 inUV;\n\t\tout vec2 UV;\n\t\tuniform mat4 VIEWPORT;\n\t\tuniform mat4 CAMERA;\n\t\t\n\t\tvoid main() {\n\t\t\tUV = inUV;\n\t\t\tgl_Position = CAMERA * VIEWPORT * INSTANCE * VERTEX;\n\t\t}\n\t\t"),e=n(r.FRAGMENT_SHADER,"#version 300 es\n\t\tprecision mediump float;\n\t\tin vec2 UV;\n\t\tout vec4 outColor;\n\t\tuniform sampler2D TEXTURE;\n\t\tuniform vec4 COLOR;\n\t\tvoid main() {\n\t\t\toutColor = texture(TEXTURE, UV)*COLOR;\n\t\t}\n\t\t");this.program=function(t,e){const a=r.createProgram();if(r.attachShader(a,t),r.attachShader(a,e),r.linkProgram(a),r.getProgramParameter(a,r.LINK_STATUS))return a;console.log(r.getProgramInfoLog(a)),r.deleteProgram(a)}(t,e),this.varList=new Map,this.varList.set("VERTEX",{type:i.Vertex,handle:null,variable:null}),this.varList.set("INSTANCE",{type:i.Instance,handle:null,variable:null}),this.varList.set("inUV",{type:i.UV,handle:null,variable:null}),this.varList.set("VIEWPORT",{type:i.Matrix,handle:null,variable:null}),this.varList.set("CAMERA",{type:i.Camera,handle:null,variable:null}),this.varList.set("TEXTURE",{type:i.Texture,handle:null,variable:null}),this.varList.set("COLOR",{type:i.Vec4,handle:null,variable:null}),this.varList.forEach((t,e)=>{switch(t.type){case i.Vertex:case i.UV:case i.Instance:t.handle=r.getAttribLocation(this.program,e);break;case i.Texture:case i.Matrix:case i.Mat4:case i.Vec4:case i.Float:case i.Camera:t.handle=r.getUniformLocation(this.program,e)}})}set(t,e){this.varList.get(t).variable=e}setColor(t){this.varList.get("COLOR").variable=[t.r,t.g,t.b,t.a]}setViewport(t){this.varList.get("VIEWPORT").variable=t}setCamera(t){this.varList.get("CAMERA").variable=t}setUV(t){this.varList.get("inUV").variable=t}setVertex(t){this.varList.get("VERTEX").variable=t}setTexture(t){this.varList.get("TEXTURE").variable=t}setInstance(t){this.varList.get("INSTANCE").variable=t}update(){r.useProgram(this.program),this.varList.forEach(t=>{switch(t.type){case i.Vertex:r.bindBuffer(r.ARRAY_BUFFER,t.variable.id),r.enableVertexAttribArray(t.handle),r.vertexAttribPointer(t.handle,3,r.FLOAT,!1,12,t.variable.offset);break;case i.UV:r.bindBuffer(r.ARRAY_BUFFER,t.variable.id),r.enableVertexAttribArray(t.handle),r.vertexAttribPointer(t.handle,2,r.FLOAT,!1,8,t.variable.offset);break;case i.Texture:r.bindTexture(r.TEXTURE_2D,t.variable),r.uniform1i(t.handle,0);break;case i.Camera:const e=r.canvas.width/r.canvas.height;t.variable.matrix.perspective(70,e,.001,20),t.variable.matrix.translate(t.variable.position.x,t.variable.position.y,t.variable.position.z),t.variable.matrix.rotateX(t.variable.rotation.x),t.variable.matrix.rotateY(t.variable.rotation.y),t.variable.matrix.rotateZ(t.variable.rotation.z),t.variable.matrix.scale(t.variable.scale.x,t.variable.scale.y,t.variable.scale.z),r.uniformMatrix4fv(t.handle,!1,t.variable.matrix.get()),t.variable.matrix.reset();break;case i.Matrix:r.uniformMatrix4fv(t.handle,!1,t.variable.get()),t.variable.reset();break;case i.Vec4:r.uniform4fv(t.handle,t.variable);break;case i.Float:r.uniform1f(t.handle,t.variable);break;case i.Instance:if(null===t.variable.id)break;r.bindBuffer(r.ARRAY_BUFFER,t.variable.id);for(let e=0;e<4;e++){const a=t.handle+e,i=16*e;r.enableVertexAttribArray(a),r.vertexAttribPointer(a,4,r.FLOAT,!1,64,i),r.vertexAttribDivisor(a,1)}}})}}var o=function(t,e,a,r){return new(a||(a=Promise))((function(i,n){function s(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,o)}l((r=r.apply(t,e||[])).next())}))};class l{constructor(){this.mat=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.tmp=new Float32Array(16)}translate(t,e,a){this.tmp.set([1,0,0,0,0,1,0,0,0,0,1,0,t,e,a,1]),this.multiplyMatrices4x4(this.mat,this.tmp)}scale(t,e,a){this.tmp.set([t,0,0,0,0,e,0,0,0,0,a,0,0,0,0,1]),this.multiplyMatrices4x4(this.mat,this.tmp)}rotateX(t){const e=Math.cos(t),a=-Math.sin(t);this.tmp.set([1,0,0,0,0,e,-a,0,0,a,e,0,0,0,0,1]),this.multiplyMatrices4x4(this.mat,this.tmp)}rotateY(t){const e=Math.cos(t),a=-Math.sin(t);this.tmp.set([e,0,-a,0,0,1,0,0,a,0,e,0,0,0,0,1]),this.multiplyMatrices4x4(this.mat,this.tmp)}rotateZ(t){const e=Math.cos(t),a=-Math.sin(t);this.tmp.set([e,-a,0,0,a,e,0,0,0,0,1,0,0,0,0,1]),this.multiplyMatrices4x4(this.mat,this.tmp)}reset(){this.mat.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}get(){return this.mat}orthographic(t,e,a,r,i,n){this.tmp.set([2/(e-t),0,0,0,0,2/(r-a),0,0,0,0,2/(i-n),0,(t+e)/(t-e),(a+r)/(a-r),(i+n)/(i-n),1]),this.multiplyMatrices4x4(this.mat,this.tmp)}perspective(t,e,a,r){const i=t*Math.PI/180,n=Math.tan(.5*Math.PI-.5*i),s=1/(a-r);this.tmp.set([n/e,0,0,0,0,n,0,0,0,0,(a+r)*s,-1,0,0,a*r*s*2,0]),this.multiplyMatrices4x4(this.mat,this.tmp)}multiplyMatrices4x4(t,e){this.mat.set([e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]])}}class c{constructor(t){this.matrix=new l,this.name=t,this.position={x:0,y:0,z:0},this.rotation={x:0,y:0,z:0},this.scale={x:0,y:0,z:0}}setAsCurrent(){u=this}setPosition(t,e,a){this.position.x=t,this.position.y=e,this.position.z=a}setRotation(t,e,a){this.rotation.x=t,this.rotation.y=e,this.rotation.z=a}setScale(t,e,a){this.scale.x=t,this.scale.y=e,this.scale.z=a}setOrtho(){}}var u=new c("default"),h=function(t,e,a,r){return new(a||(a=Promise))((function(i,n){function s(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,o)}l((r=r.apply(t,e||[])).next())}))};class f{constructor(){}createInstance(t){const e=new Float32Array(16*t.length);t.forEach((t,a)=>{e.set(t.get(),16*a)}),console.log(t.length,e.length),this.instance.count=t.length,this.instance.id=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,this.instance.id),r.bufferData(r.ARRAY_BUFFER,e,r.STATIC_DRAW)}render(){this.shader.setTexture(this.texture),this.shader.setViewport(this.viewport),this.shader.setCamera(u),this.shader.setColor(this.color),this.shader.setVertex(this.vertex),this.shader.setUV(this.uv),this.shader.setInstance(this.instance),this.shader.update(),r.drawArraysInstanced(r.TRIANGLES,0,this.vertex.count,this.instance.count)}}function v(t){return h(this,void 0,void 0,(function*(){const e=yield function(t){return o(this,void 0,void 0,(function*(){return yield(yield fetch(t)).json()}))}(t),a=new Map,i=new s,n=r.createTexture(),c=t.split(/(\/|\\)/).reduce((t,e,a,r)=>a!==r.length-1?t+e:t),u=c===t?"":c;i.setTexture(n);const h=new Image;h.src=u+e.images[0].uri,h.onload=()=>{r.bindTexture(r.TEXTURE_2D,n),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,h),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)};const v=yield(yield(yield fetch(u+e.buffers[0].uri)).blob()).arrayBuffer(),d=new Uint8Array(v),m=r.createBuffer();return r.bindBuffer(r.ARRAY_BUFFER,m),r.bufferData(r.ARRAY_BUFFER,d,r.STATIC_DRAW),e.nodes.forEach((t,r)=>{const s=new f;s.viewport=new l,s.color={r:1,g:1,b:1,a:1},s.shader=i,s.shader.setViewport(s.viewport),s.shader.setColor(s.color),s.texture=n,s.position={translation:{x:null==t.translation?0:t.translation[0],y:null==t.translation?0:t.translation[1],z:null==t.translation?0:t.translation[2]},rotation:{x:null==t.rotation?0:t.rotation[0],y:null==t.rotation?0:t.rotation[1],z:null==t.rotation?0:t.rotation[2]},scale:{x:null==t.scale?0:t.scale[0],y:null==t.scale?0:t.scale[1],z:null==t.scale?0:t.scale[2]}};const o=e.meshes[t.mesh].primitives[0].attributes.POSITION,c=e.accessors[o].bufferView,u=e.meshes[t.mesh].primitives[0].attributes.TEXCOORD_0,h=e.accessors[u].bufferView;s.vertex={id:m,count:e.accessors[o].count,offset:e.bufferViews[c].byteOffset,size:e.bufferViews[c].byteLength},s.uv={id:m,count:e.accessors[u].count,offset:e.bufferViews[h].byteOffset,size:e.bufferViews[h].byteLength},s.instance={id:null,count:1,offset:0,size:0},s.shader.setVertex(s.vertex),s.shader.setUV(s.uv),a.set(t.name,s)}),a}))}var d=function(t,e,a,r){return new(a||(a=Promise))((function(i,n){function s(t){try{l(r.next(t))}catch(t){n(t)}}function o(t){try{l(r.throw(t))}catch(t){n(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(s,o)}l((r=r.apply(t,e||[])).next())}))};window.onload=()=>d(void 0,void 0,void 0,(function*(){!function(t){const e=document.querySelector(t);null===(r=e.getContext("webgl2",{stencil:!0}))&&alert("Unable to initialize WebGL2. Your browser or machine may not support it.")}("#glCanvas");const t=yield v("./data/snake.gltf");console.log(t);t.get("head"),t.get("midle"),t.get("tail");const e=t.get("arena"),a=new c("one");a.setAsCurrent(),a.setPosition(0,-.3,0),a.setRotation(0,2,-.5),a.setScale(.4,.4,.4);let i=.1;r.enable(r.DEPTH_TEST),r.enable(r.STENCIL_TEST),r.enable(r.BLEND),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.stencilOp(r.KEEP,r.KEEP,r.REPLACE);let n=0,s=0,o=0;const u=new Array(1e4);for(let t=0;t<100;t++)for(let e=0;e<100;e++){const a=new l;a.translate(t%2==0?.16*e+.08:.16*e,.14*t,0),a.scale(1,1,(h=.1,f=2,Math.random()*(f-h)+h)),u[100*t+e]=a}var h,f;e.createInstance(u);var d=function(t,e,a){let r=-a,i=t;return function(){return i+=i>=e||i<=t?r=-r:r}}(-1,1,.01);const m=()=>{s=performance.now(),n+=Math.min(1,(s-o)/1e3),r.clearColor(0,.5,0,1),r.clearStencil(0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT),r.viewport(0,0,r.canvas.width,r.canvas.height),i+=.005,a.setRotation(.19,-i,i),e.viewport.translate(-2,-1.1,0),e.viewport.rotateX(1.5),e.viewport.rotateZ(-i),e.viewport.translate(-5,-5,0),e.render(),r.bindBuffer(r.ARRAY_BUFFER,e.instance.id);const t=new l;t.translate(0,0,d()),r.bufferSubData(r.ARRAY_BUFFER,0,t.get()),o=s,requestAnimationFrame(m)};requestAnimationFrame(m)}))}]);