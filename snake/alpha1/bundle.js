!function(t){var e={};function i(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(n,s,function(e){return t[e]}.bind(null,s));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=5)}([function(t,e,i){var n=i(1),s=i(2);"string"==typeof(s=s.__esModule?s.default:s)&&(s=[[t.i,s,""]]);var r={insert:"head",singleton:!1};n(s,r);t.exports=s.locals||{}},function(t,e,i){"use strict";var n,s=function(){return void 0===n&&(n=Boolean(window&&document&&document.all&&!window.atob)),n},r=function(){var t={};return function(e){if(void 0===t[e]){var i=document.querySelector(e);if(window.HTMLIFrameElement&&i instanceof window.HTMLIFrameElement)try{i=i.contentDocument.head}catch(t){i=null}t[e]=i}return t[e]}}(),a=[];function o(t){for(var e=-1,i=0;i<a.length;i++)if(a[i].identifier===t){e=i;break}return e}function h(t,e){for(var i={},n=[],s=0;s<t.length;s++){var r=t[s],h=e.base?r[0]+e.base:r[0],l=i[h]||0,c="".concat(h," ").concat(l);i[h]=l+1;var u=o(c),d={css:r[1],media:r[2],sourceMap:r[3]};-1!==u?(a[u].references++,a[u].updater(d)):a.push({identifier:c,updater:v(d,e),references:1}),n.push(c)}return n}function l(t){var e=document.createElement("style"),n=t.attributes||{};if(void 0===n.nonce){var s=i.nc;s&&(n.nonce=s)}if(Object.keys(n).forEach((function(t){e.setAttribute(t,n[t])})),"function"==typeof t.insert)t.insert(e);else{var a=r(t.insert||"head");if(!a)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");a.appendChild(e)}return e}var c,u=(c=[],function(t,e){return c[t]=e,c.filter(Boolean).join("\n")});function d(t,e,i,n){var s=i?"":n.media?"@media ".concat(n.media," {").concat(n.css,"}"):n.css;if(t.styleSheet)t.styleSheet.cssText=u(e,s);else{var r=document.createTextNode(s),a=t.childNodes;a[e]&&t.removeChild(a[e]),a.length?t.insertBefore(r,a[e]):t.appendChild(r)}}function f(t,e,i){var n=i.css,s=i.media,r=i.sourceMap;if(s?t.setAttribute("media",s):t.removeAttribute("media"),r&&btoa&&(n+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleSheet)t.styleSheet.cssText=n;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(n))}}var p=null,m=0;function v(t,e){var i,n,s;if(e.singleton){var r=m++;i=p||(p=l(e)),n=d.bind(null,i,r,!1),s=d.bind(null,i,r,!0)}else i=l(e),n=f.bind(null,i,e),s=function(){!function(t){if(null===t.parentNode)return!1;t.parentNode.removeChild(t)}(i)};return n(t),function(e){if(e){if(e.css===t.css&&e.media===t.media&&e.sourceMap===t.sourceMap)return;n(t=e)}else s()}}t.exports=function(t,e){(e=e||{}).singleton||"boolean"==typeof e.singleton||(e.singleton=s());var i=h(t=t||[],e);return function(t){if(t=t||[],"[object Array]"===Object.prototype.toString.call(t)){for(var n=0;n<i.length;n++){var s=o(i[n]);a[s].references--}for(var r=h(t,e),l=0;l<i.length;l++){var c=o(i[l]);0===a[c].references&&(a[c].updater(),a.splice(c,1))}i=r}}}},function(t,e,i){(e=i(3)(!1)).push([t.i,"#glCanvas {\r\n\tpadding: 0;\r\n\tmargin: auto;\r\n\tdisplay: flex;\r\n\twidth: 80%;\r\n\tposition: absolute;\r\n\ttop: 0;\r\n\tbottom: 0;\r\n\tleft: 0;\r\n\tright: 0;\r\n}",""]),t.exports=e},function(t,e,i){"use strict";t.exports=function(t){var e=[];return e.toString=function(){return this.map((function(e){var i=function(t,e){var i=t[1]||"",n=t[3];if(!n)return i;if(e&&"function"==typeof btoa){var s=(a=n,o=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),h="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(o),"/*# ".concat(h," */")),r=n.sources.map((function(t){return"/*# sourceURL=".concat(n.sourceRoot||"").concat(t," */")}));return[i].concat(r).concat([s]).join("\n")}var a,o,h;return[i].join("\n")}(e,t);return e[2]?"@media ".concat(e[2]," {").concat(i,"}"):i})).join("")},e.i=function(t,i,n){"string"==typeof t&&(t=[[null,t,""]]);var s={};if(n)for(var r=0;r<this.length;r++){var a=this[r][0];null!=a&&(s[a]=!0)}for(var o=0;o<t.length;o++){var h=[].concat(t[o]);n&&s[h[0]]||(i&&(h[2]?h[2]="".concat(i," and ").concat(h[2]):h[2]=i),e.push(h))}},e}},function(t,e){t.exports="<html> <body> <canvas id=glCanvas width=1280 height=720></canvas> </body> </html>"},function(t,e,i){"use strict";i.r(e);var n,s,r;i(0),i(4);function a(t,e){const i=n.createShader(t);if(n.shaderSource(i,e),n.compileShader(i),n.getShaderParameter(i,n.COMPILE_STATUS))return i;console.log(n.getShaderInfoLog(i)),n.deleteShader(i)}class o{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}add(t){return"number"==typeof t?new o(this.x+t,this.y+t,this.z+t):t instanceof o?new o(this.x+t.x,this.y+t.y,this.z+t.z):void 0}subtract(t){return"number"==typeof t?new o(this.x-t,this.y-t,this.z-t):t instanceof o?new o(this.x-t.x,this.y-t.y,this.z-t.z):void 0}multiply(t){return"number"==typeof t?new o(this.x*t,this.y*t,this.z*t):t instanceof o?new o(this.x*t.x,this.y*t.y,this.z*t.z):void 0}division(t){return"number"==typeof t?new o(this.x/t,this.y/t,this.z/t):t instanceof o?new o(this.x/t.x,this.y/t.y,this.z/t.z):void 0}directionAngle(t){const e=t*Math.PI/180;return new o(this.x+Math.sin(e),this.y+Math.cos(e),0)}directionRadius(t){return new o(this.x+Math.sin(t),this.y+Math.cos(t),0)}reversDirectionRadius(t){return new o(this.x-Math.sin(t),this.y-Math.cos(t),0)}dot(t){const e=this.multiply(t);return e.x+e.y+e.z}normalize(){const t=new o,e=Math.sqrt(this.dot(this));return e>1e-5&&(t.x=this.x/e,t.y=this.y/e,t.z=this.z/e),t}slerp(t,e){const i=this.dot(t);!function(t,e,i){t<e?t=e:t>i&&(t=i)}(i,-1,1);const n=Math.acos(i)*e,s=t.subtract(this).multiply(i).normalize();return this.multiply(Math.cos(n)).add(s.multiply(Math.sin(n)))}}class h{constructor(){this.mat=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.tmp=new Float32Array(16)}translate(t){this.tmp.set([1,0,0,0,0,1,0,0,0,0,1,0,t.x,t.y,t.z,1]),this.multiply(this.mat,this.tmp)}translateX(t){this.tmp.set([1,0,0,0,0,1,0,0,0,0,1,0,t,0,0,1]),this.multiply(this.mat,this.tmp)}translateY(t){this.tmp.set([1,0,0,0,0,1,0,0,0,0,1,0,0,t,0,1]),this.multiply(this.mat,this.tmp)}translateZ(t){this.tmp.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,t,1]),this.multiply(this.mat,this.tmp)}scale(t){this.tmp.set([t.x,0,0,0,0,t.y,0,0,0,0,t.z,0,0,0,0,1]),this.multiply(this.mat,this.tmp)}scaleX(t){this.tmp.set([t,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.multiply(this.mat,this.tmp)}scaleY(t){this.tmp.set([1,0,0,0,0,t,0,0,0,0,1,0,0,0,0,1]),this.multiply(this.mat,this.tmp)}scaleZ(t){this.tmp.set([1,0,0,0,0,1,0,0,0,0,t,0,0,0,0,1]),this.multiply(this.mat,this.tmp)}rotateX(t){const e=Math.cos(t),i=Math.sin(t);this.tmp.set([1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1]),this.multiply(this.mat,this.tmp)}rotateY(t){const e=Math.cos(t),i=Math.sin(t);this.tmp.set([e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1]),this.multiply(this.mat,this.tmp)}rotateZ(t){const e=Math.cos(t),i=Math.sin(t);this.tmp.set([e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1]),this.multiply(this.mat,this.tmp)}identity(){this.mat.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}get(){return this.mat}set(t){this.mat.set(t)}orthographic(t,e,i,n,s,r){this.tmp.set([2/(e-t),0,0,0,0,2/(n-i),0,0,0,0,2/(s-r),0,(t+e)/(t-e),(i+n)/(i-n),(s+r)/(s-r),1]),this.multiply(this.mat,this.tmp)}perspective(t,e,i,n){const s=t*Math.PI/180,r=Math.tan(.5*Math.PI-.5*s),a=1/(i-n);this.tmp.set([r/e,0,0,0,0,r,0,0,0,0,(i+n)*a,-1,0,0,i*n*a*2,0]),this.multiply(this.mat,this.tmp)}lookAt(t,e,i){const n=l(function(t,e){const i=new Array(3);return i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i}(t,e)),s=l(c(i,n)),r=l(c(n,s));this.tmp.set([s[0],s[1],s[2],0,r[0],r[1],r[2],0,n[0],n[1],n[2],0,0,0,0,1]),this.multiply(this.mat,this.tmp)}multiply(t,e){this.mat.set([e[0]*t[0]+e[1]*t[4]+e[2]*t[8]+e[3]*t[12],e[0]*t[1]+e[1]*t[5]+e[2]*t[9]+e[3]*t[13],e[0]*t[2]+e[1]*t[6]+e[2]*t[10]+e[3]*t[14],e[0]*t[3]+e[1]*t[7]+e[2]*t[11]+e[3]*t[15],e[4]*t[0]+e[5]*t[4]+e[6]*t[8]+e[7]*t[12],e[4]*t[1]+e[5]*t[5]+e[6]*t[9]+e[7]*t[13],e[4]*t[2]+e[5]*t[6]+e[6]*t[10]+e[7]*t[14],e[4]*t[3]+e[5]*t[7]+e[6]*t[11]+e[7]*t[15],e[8]*t[0]+e[9]*t[4]+e[10]*t[8]+e[11]*t[12],e[8]*t[1]+e[9]*t[5]+e[10]*t[9]+e[11]*t[13],e[8]*t[2]+e[9]*t[6]+e[10]*t[10]+e[11]*t[14],e[8]*t[3]+e[9]*t[7]+e[10]*t[11]+e[11]*t[15],e[12]*t[0]+e[13]*t[4]+e[14]*t[8]+e[15]*t[12],e[12]*t[1]+e[13]*t[5]+e[14]*t[9]+e[15]*t[13],e[12]*t[2]+e[13]*t[6]+e[14]*t[10]+e[15]*t[14],e[12]*t[3]+e[13]*t[7]+e[14]*t[11]+e[15]*t[15]])}}function l(t){const e=new Array(3),i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return i>1e-5&&(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i),e}function c(t,e){const i=new Array(3);return i[0]=t[1]*e[2]-t[2]*e[1],i[1]=t[2]*e[0]-t[0]*e[2],i[2]=t[0]*e[1]-t[1]*e[0],i}function u(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t}!function(t){t[t.Vertex=0]="Vertex",t[t.Instance=1]="Instance",t[t.Uniform=2]="Uniform",t[t.Texture=3]="Texture",t[t.Matrix=4]="Matrix",t[t.UV=5]="UV",t[t.Mat4=6]="Mat4",t[t.Float=7]="Float",t[t.Vec4=8]="Vec4"}(r||(r={}));class d{constructor(){this.viewport=new h;const t=a(n.VERTEX_SHADER,"#version 300 es\n\t\tin vec4 VERTEX;\n\t\tin mat4 INSTANCE;\n\t\tin vec2 inUV;\n\t\tout vec2 UV;\n\t\tuniform mat4 VIEWPORT;\n\t\tuniform mat4 CAMERA;\n\t\t\n\t\tvoid main() {\n\t\t\tUV = inUV;\n\t\t\tgl_Position = CAMERA * VIEWPORT * INSTANCE * VERTEX;\n\t\t}\n\t\t"),e=a(n.FRAGMENT_SHADER,"#version 300 es\n\t\tprecision mediump float;\n\t\tin vec2 UV;\n\t\tout vec4 outColor;\n\t\tuniform sampler2D TEXTURE;\n\t\tuniform vec4 COLOR;\n\t\tvoid main() {\n\t\t\toutColor = texture(TEXTURE, UV)*COLOR;\n\t\t}\n\t\t");this.program=function(t,e){const i=n.createProgram();if(n.attachShader(i,t),n.attachShader(i,e),n.linkProgram(i),n.getProgramParameter(i,n.LINK_STATUS))return i;console.log(n.getProgramInfoLog(i)),n.deleteProgram(i)}(t,e),this.varList=new Map,this.varList.set("VERTEX",{type:r.Vertex,handle:null,var:null}),this.varList.set("INSTANCE",{type:r.Instance,handle:null,var:null}),this.varList.set("inUV",{type:r.UV,handle:null,var:null}),this.varList.set("VIEWPORT",{type:r.Matrix,handle:null,var:null}),this.varList.set("CAMERA",{type:r.Matrix,handle:null,var:null}),this.varList.set("TEXTURE",{type:r.Texture,handle:null,var:null}),this.varList.set("COLOR",{type:r.Vec4,handle:null,var:null}),this.varList.forEach((t,e)=>{switch(t.type){case r.Vertex:case r.UV:case r.Instance:t.handle=n.getAttribLocation(this.program,e);break;case r.Texture:case r.Matrix:case r.Mat4:case r.Vec4:case r.Float:t.handle=n.getUniformLocation(this.program,e)}})}set(t,e){this.varList.get(t).var=e}setColor(t){this.varList.get("COLOR").var=[t.r,t.g,t.b,t.a]}setViewport(t){this.varList.get("VIEWPORT").var=t}setCamera(t){this.varList.get("CAMERA").var=t.getView()}setUV(t){this.varList.get("inUV").var=t}setVertex(t){this.varList.get("VERTEX").var=t}setTexture(t){this.varList.get("TEXTURE").var=t}setInstance(t){this.varList.get("INSTANCE").var=t}update(){n.useProgram(this.program),this.varList.forEach(t=>{switch(t.type){case r.Vertex:n.bindBuffer(n.ARRAY_BUFFER,t.var.id),n.enableVertexAttribArray(t.handle),n.vertexAttribPointer(t.handle,3,n.FLOAT,!1,12,t.var.offset);break;case r.UV:n.bindBuffer(n.ARRAY_BUFFER,t.var.id),n.enableVertexAttribArray(t.handle),n.vertexAttribPointer(t.handle,2,n.FLOAT,!1,8,t.var.offset);break;case r.Texture:n.bindTexture(n.TEXTURE_2D,t.var),n.uniform1i(t.handle,0);break;case r.Matrix:n.uniformMatrix4fv(t.handle,!1,t.var.get());break;case r.Vec4:n.uniform4fv(t.handle,t.var);break;case r.Float:n.uniform1f(t.handle,t.var);break;case r.Instance:n.bindBuffer(n.ARRAY_BUFFER,t.var.id);for(let e=0;e<4;e++){const i=t.handle+e,s=16*e;n.enableVertexAttribArray(i),n.vertexAttribPointer(i,4,n.FLOAT,!1,64,s),n.vertexAttribDivisor(i,1)}}})}}var f,p=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.Perspective=0]="Perspective",t[t.Ortho=1]="Ortho",t[t.None=2]="None"}(f||(f={}));class m{constructor(t,e=f.Perspective,i=70,n=.001,s=20){this.name=t,this.fov=i,this.type=e,this.distance={near:n,far:s},this.view=new h,this.aspect=0}setAsCurrent(){v=this}identity(){switch(this.aspect=s.width/s.height,this.view.identity(),this.type){case f.Perspective:this.view.perspective(this.fov,this.aspect,this.distance.near,this.distance.far)}}position(t){this.view.translate(t)}rotation(t){this.view.rotateX(t.x),this.view.rotateY(t.y),this.view.rotateZ(t.z)}scale(t){this.view.scale(t)}setFov(t){this.fov=t}zoom(t){this.view.scale(new o(t,t,t))}getView(){return this.view}}var v=new m("default"),y=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class w{constructor(){this.view=new h,this.origin={translation:new o,scale:new o,rotate:new o}}position(t){this.view.translate(t)}rotation(t){this.view.rotateX(t.x),this.view.rotateY(t.y),this.view.rotateZ(t.z)}scale(t){this.view.scale(t)}identity(){this.view.identity()}createInstance(t){const e=new Float32Array(16*t.length);t.forEach((t,i)=>{e.set(t.get(),16*i)}),this.instance.count=t.length,n.bindBuffer(n.ARRAY_BUFFER,this.instance.id),n.bufferData(n.ARRAY_BUFFER,e,n.STATIC_DRAW)}updateInstance(t,e){n.bindBuffer(n.ARRAY_BUFFER,this.instance.id),n.bufferSubData(n.ARRAY_BUFFER,64*t,e.get())}render(){this.shader.setTexture(this.texture),this.shader.setViewport(this.view),this.shader.setCamera(v),this.shader.setColor(this.color),this.shader.setVertex(this.vertex),this.shader.setUV(this.uv),this.shader.setInstance(this.instance),this.shader.update(),n.drawArraysInstanced(n.TRIANGLES,0,this.vertex.count,this.instance.count)}}function g(t){return y(this,void 0,void 0,(function*(){const e=yield function(t){return p(this,void 0,void 0,(function*(){return yield(yield fetch(t)).json()}))}(t),i=new Map,s=new d,r=n.createTexture(),a=t.split(/(\/|\\)/).reduce((t,e,i,n)=>i!==n.length-1?t+e:t),o=a===t?"":a;s.setTexture(r);const l=new Image;l.src=o+e.images[0].uri,l.onload=()=>{n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,l),n.generateMipmap(n.TEXTURE_2D)};const c=yield(yield(yield fetch(o+e.buffers[0].uri)).blob()).arrayBuffer(),u=new Uint8Array(c),f=n.createBuffer();return n.bindBuffer(n.ARRAY_BUFFER,f),n.bufferData(n.ARRAY_BUFFER,u,n.STATIC_DRAW),e.nodes.forEach((t,a)=>{const o=new w;o.color={r:1,g:1,b:1,a:1},o.shader=s,o.shader.setViewport(o.view),o.shader.setColor(o.color),o.texture=r,o.origin.translation.x=null==t.translation?0:t.translation[0],o.origin.translation.y=null==t.translation?0:t.translation[1],o.origin.translation.z=null==t.translation?0:t.translation[2],o.origin.rotate.x=null==t.rotation?0:t.rotation[0],o.origin.rotate.y=null==t.rotation?0:t.rotation[1],o.origin.rotate.z=null==t.rotation?0:t.rotation[2],o.origin.scale.x=null==t.scale?1:t.scale[0],o.origin.scale.y=null==t.scale?1:t.scale[1],o.origin.scale.z=null==t.scale?1:t.scale[2];const l=e.meshes[t.mesh].primitives[0].attributes.POSITION,c=e.accessors[l].bufferView,u=e.meshes[t.mesh].primitives[0].attributes.TEXCOORD_0,d=e.accessors[u].bufferView;o.vertex={id:f,count:e.accessors[l].count,offset:e.bufferViews[c].byteOffset,size:e.bufferViews[c].byteLength},o.uv={id:f,count:e.accessors[u].count,offset:e.bufferViews[d].byteOffset,size:e.bufferViews[d].byteLength},o.instance={id:n.createBuffer(),count:1,offset:0,size:0},n.bindBuffer(n.ARRAY_BUFFER,o.instance.id),n.bufferData(n.ARRAY_BUFFER,(new h).get(),n.STATIC_DRAW),o.shader.setVertex(o.vertex),o.shader.setUV(o.uv),i.set(t.name,o)}),i}))}var b=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};class x{constructor(t){var e;this.loop=t,e="#glCanvas",s=document.querySelector(e),null===(n=s.getContext("webgl2",{stencil:!0}))&&alert("Unable to initialize WebGL2. Your browser or machine may not support it."),n.enable(n.DEPTH_TEST),n.enable(n.STENCIL_TEST),n.enable(n.BLEND),n.blendFunc(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA),n.stencilOp(n.KEEP,n.KEEP,n.REPLACE)}run(){return b(this,void 0,void 0,(function*(){yield this.loop.init();let t=0,e=0,i=0;const s=()=>{for(e=performance.now(),t+=Math.min(1,(e-i)/1e3),n.clearColor(0,0,0,1),n.clearStencil(0),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight);t>1/60;)t-=1/60,this.loop.update(1/60);this.loop.render(t),i=e,requestAnimationFrame(s)};requestAnimationFrame(s)}))}}class A{constructor(t,e,i){this.x=t,this.y=e,this.r=i}collisionTo(t){const e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)<this.r+t.r}moveTo(t){return new A(t.x,t.y,this.r)}}var E,T=function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function a(t){try{h(n.next(t))}catch(t){r(t)}}function o(t){try{h(n.throw(t))}catch(t){r(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(a,o)}h((n=n.apply(t,e||[])).next())}))};!function(t){t[t.up=0]="up",t[t.left=1]="left",t[t.right=2]="right"}(E||(E={}));class R{constructor(t,e){this.rotate=0,this.angle=0,this.id=0,this.cell=0,this.node=t,this.view=new h,this.position=this.node.origin.translation.add(e),this.collision=new A(this.position.x,this.position.y,.005),this.rotateSpeed=10}moveTo(t){this.position=this.position.add(new o(0,0,0).reversDirectionRadius(this.rotate).multiply(t))}update(t){this.position=this.position.add((new o).directionRadius(this.rotate).multiply(t)),this.rotate<this.angle&&this.rotateDirection==E.left?this.angle+=-t*this.rotateSpeed:this.rotate>this.angle&&this.rotateDirection==E.right?this.angle+=t*this.rotateSpeed:this.angle=this.rotate,this.view.identity(),this.view.translate(this.position),this.view.rotateZ(this.angle),this.node.updateInstance(this.id,this.view)}collisionTo(t){return!!this.collision.moveTo(this.position).collisionTo(t)}}window.onload=()=>{new x(new class{init(){return T(this,void 0,void 0,(function*(){const t=yield g("./data/snake.gltf");this.arena=t.get("arena"),this.cam=new m("main"),this.cam.setAsCurrent();const e=new Array(256);this.arenaCollision=new Array(256);for(let t=0;t<16;t++)for(let i=0;i<16;i++){const n=new h;let s=0;n.translate(new o(.136*i,i%2==0?.156*t+.08:.156*t,s)),n.rotateZ(90*Math.PI/180),e[16*i+t]=n,this.arenaCollision[16*i+t]=new A(.136*i,i%2==0?.156*t+.08:.156*t,.0025),s=0}this.arena.createInstance(e),this.speed=.45;const i=this.arenaCollision.length/2;this.controlCollision=new A(this.arenaCollision[i].x,this.arenaCollision[i].y,.1),window.addEventListener("keydown",t=>{"a"===t.key&&(this.direction=E.left),"d"===t.key&&(this.direction=E.right)}),window.addEventListener("keyup",t=>{}),this.pressKey=!1,this.midleSnakeInstance=new Array(50),this.midleSnakeNode=new Array(50),this.midle=t.get("midle");for(let t=0;t<100;t++)this.midleSnakeInstance[t]=new h,this.midleSnakeInstance[t].scale(new o),this.midleSnakeNode[t]=new R(this.midle,new o(this.arenaCollision[i].x,this.arenaCollision[i].y,.05));this.midle.createInstance(this.midleSnakeInstance),this.head=new R(t.get("head"),new o(this.arenaCollision[i].x,this.arenaCollision[i].y,.05)),this.tail=new R(t.get("tail"),new o(this.arenaCollision[i].x,this.arenaCollision[i].y,.05)),this.up=t.get("up");const n=u(0,this.arenaCollision.length);this.powerUpCell=n,this.up.position(new o(this.arenaCollision[n].x,this.arenaCollision[n].y,.1)),this.up.scale(new o(.05,.05,.05)),this.cell=0,this.stack=new Array,this.snakeSize=1}))}update(t){let e=this.speed*t;this.cam.identity(),this.cam.rotation(new o(.7,0,0)),this.head.update(e),this.midleSnakeNode.forEach(t=>{t.update(e)}),this.tail.update(e),this.cam.position(new o(0,.8,-1).subtract(this.head.position)),this.arenaCollision.forEach((t,e)=>{if(this.pressKey&&(this.pressKey=!1),this.head.collisionTo(t)&&this.cell!==e){if(e===this.powerUpCell){const t=this.midleSnakeNode[this.snakeSize];t.id=this.snakeSize,t.moveTo(-t.node.origin.translation.y*this.snakeSize),this.tail.moveTo(-t.node.origin.translation.y),this.snakeSize++;const e=u(0,this.arenaCollision.length);this.powerUpCell=e,this.up.identity(),this.up.position(new o(this.arenaCollision[e].x,this.arenaCollision[e].y,.1)),this.up.scale(new o(.05,.05,.05))}switch(this.direction){case E.left:this.head.rotateDirection=E.left,this.head.rotate+=-60*Math.PI/180;break;case E.right:this.head.rotateDirection=E.right,this.head.rotate+=60*Math.PI/180;break;case E.up:}this.direction=E.up,this.head.position=new o(t.x,t.y,.05),this.cell=e,this.stack.unshift({cell:e,direction:this.head.rotate})}this.stack.forEach(i=>{this.midleSnakeNode.forEach(n=>{n.collisionTo(t)&&i.cell===e&&i.cell!==n.cell&&(n.rotate=i.direction,n.position=new o(t.x,t.y,.05),n.cell=i.cell)}),this.tail.collisionTo(t)&&i.cell===e&&(this.tail.rotate=i.direction,this.tail.position=new o(t.x,t.y,.05),this.stack.pop())})})}render(t){this.arena.render(),this.up.render(),this.head.node.render(),this.midle.render(),this.tail.node.render()}}).run();!function(t,e,i){let n=-i,s=t}(-1,1,.01)}}]);